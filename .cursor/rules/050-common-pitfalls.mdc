---
description: PiÃ¨ges courants et leÃ§ons apprises - Erreurs frÃ©quentes Ã  Ã©viter
globs: ["**/*.php", "**/*.scss", "**/*.vue", "**/*.ts", "config/*.yml"]
alwaysApply: true
---

# PiÃ¨ges Courants et LeÃ§ons Apprises

## âš ï¸ RÃˆGLES CRITIQUES

Ce document contient les erreurs frÃ©quemment rencontrÃ©es et leurs solutions.
**Lire obligatoirement avant tout dÃ©veloppement.**

---

## ğŸ”§ Installation du Module (CRITIQUE)

### ABSOLUMENT utiliser ModuleInstaller

**NE JAMAIS implÃ©menter l'installation directement dans `install()`.** **Toujours utiliser `ModuleInstaller`** qui orchestre tous les sous-installateurs (database, tabs, hooks, configurations).

```php
// âŒ ERREUR - Installation directe dans install()
class ModuleStarter extends Module
{
    public function install(): bool
    {
        // âŒ NE PAS FAIRE - Code d'installation Ã©parpillÃ©
        if (!parent::install()) {
            return false;
        }

        // âŒ Base de donnÃ©es Ã©parpillÃ©e
        Db::getInstance()->execute("CREATE TABLE ...");

        // âŒ Onglets Ã©parpillÃ©s
        $tab = new Tab();
        $tab->save();

        // âŒ Hooks Ã©parpillÃ©s
        $this->registerHook('displayHome');

        return true;
    }
}

// âœ… SOLUTION - Utiliser ModuleInstaller exclusivement
class ModuleStarter extends Module
{
    public function install(): bool
    {
        try {
            $installer = new ModuleInstaller($this);

            // Install module base
            if (!parent::install()) {
                return false;
            }

            // Run main installer (database, configs, etc.)
            return $installer->install();
        } catch (\Exception $e) {
            PrestaShopLogger::addLog(
                "Module installation failed: " . $e->getMessage(),
                3,
                null,
                $this->name
            );
            return false;
        }
    }
}
```

**Pourquoi cette rÃ¨gle est CRITIQUE ?**
- **Centralisation** : Toute la logique d'installation dans un seul endroit
- **TestabilitÃ©** : `ModuleInstaller` peut Ãªtre testÃ© unitairement
- **Maintenance** : Configuration dÃ©clarative dans `services.yml`
- **Robustesse** : Gestion d'erreurs centralisÃ©e avec logs
- **Ã‰volutivitÃ©** : Ajout de nouveaux installateurs sans modifier le module principal

**Configuration dans `services.yml` :**
```yaml
# âš ï¸ CRITIQUE - ModuleInstaller doit Ãªtre configurÃ© ici
ModuleStarter\Application\Installer\ModuleInstaller:
    arguments:
        $configuration:
            database: '@ModuleStarter\Application\Installer\DatabaseInstaller'
            configurations: '@ModuleStarter\Application\Installer\ConfigurationInstaller'
            tabs: '@ModuleStarter\Application\Installer\TabInstaller'
            hooks: '@ModuleStarter\Application\Installer\HookInstaller'
```

**RÃ¨gle absolue :**
- âœ… `install()` â†’ `new ModuleInstaller($this)` â†’ `$installer->install()`
- âœ… Configuration dÃ©clarative dans `services.yml`
- âœ… Gestion d'erreurs avec `try/catch` et logs
- âŒ Jamais de code d'installation directement dans `install()`
- âŒ Jamais d'accÃ¨s direct Ã  `Db`, `Tab`, etc. dans le module principal

**Checklist installation :**
- [ ] MÃ©thode `install()` utilise uniquement `ModuleInstaller`
- [ ] Configuration dans `services.yml` dÃ©clarÃ©e
- [ ] Cache Symfony vidÃ© aprÃ¨s installation
- [ ] Gestion d'erreurs avec logs PrestaShopLogger
- [ ] Tests unitaires pour `ModuleInstaller`

---
## ğŸ¨ Frontend & Styles

### TOUJOURS utiliser SCSS, jamais CSS

```
âŒ NE JAMAIS crÃ©er de fichiers .css directement
   views/css/admin.css  â† INTERDIT

âœ… TOUJOURS crÃ©er les styles en SCSS
   _dev/scss/admin.scss  â† CORRECT
   â†’ CompilÃ© vers views/css/admin.css via Webpack
```

**Structure des sources et outputs:**
```
_dev/                          # â† SOURCES (modifier ici)
â”œâ”€â”€ scss/
â”‚   â”œâ”€â”€ admin.scss
â”‚   â”œâ”€â”€ front.scss
â”‚   â”œâ”€â”€ _variables.scss
â”‚   â””â”€â”€ _mixins.scss
â””â”€â”€ js/
    â”œâ”€â”€ admin.js
    â””â”€â”€ front.js

views/dist/                    # â† BUILD (gÃ©nÃ©rÃ© par Webpack Encore)
â”œâ”€â”€ admin.css                  # CompilÃ© depuis _dev/scss/admin.scss
â”œâ”€â”€ admin.js                   # CompilÃ© depuis _dev/js/admin.js
â”œâ”€â”€ front.css                  # CompilÃ© depuis _dev/scss/front.scss
â”œâ”€â”€ front.js                   # CompilÃ© depuis _dev/js/front.js
â””â”€â”€ manifest.json

âš ï¸ NE JAMAIS crÃ©er views/css/ ou views/js/ - c'est views/dist/ !
```

### Build des assets obligatoire

AprÃ¨s toute modification des sources `_dev/`:

```bash
npm run build          # Production
npm run dev            # DÃ©veloppement avec watch
```

---

## ğŸ”§ ContrÃ´leurs API (CRITIQUE)

### Conflits de noms de mÃ©thodes

`FrameworkBundleAdminController` dÃ©finit une mÃ©thode `get()` pour accÃ©der aux services du container. **NE JAMAIS crÃ©er de mÃ©thode `get()` dans un contrÃ´leur API.**

```php
// âŒ ERREUR - Conflit avec FrameworkBundleAdminController::get()
class ValueApiController extends FrameworkBundleAdminController
{
    public function get(int $id): JsonResponse  // COMPILE ERROR!
    {
        // ...
    }
}

// âœ… SOLUTION - Utiliser un nom diffÃ©rent
class ValueApiController extends FrameworkBundleAdminController
{
    public function show(int $id): JsonResponse  // â† Renommer en 'show'
    {
        // ...
    }
}
```

**Noms Ã  Ã©viter dans les contrÃ´leurs Symfony:**
| MÃ©thode rÃ©servÃ©e | Alternative |
|----|----|
| `get()` | `show()`, `read()`, `fetch()` |
| `has()` | `exists()`, `check()` |
| `container()` | Autre nom |

---

## ğŸ“¦ Services Symfony (services.yml)

### Import des routes avec options explicites

**PrestaShop 8** peut avoir des difficultÃ©s Ã  charger automatiquement `routes.yml`. **Importer explicitement** avec les bonnes options.

```yaml
# Module Starter - Services Symfony
# Documentation: https://devdocs.prestashop.com/8/modules/concepts/services/

# PrestaShop 8 - Import des routes (CRITIQUE pour PS8)
imports:
    - { resource: routes.yml, type: yaml, ignore_errors: true }

services:
    _defaults:
        autowire: true
        autoconfigure: true
        public: false
```

**Options importantes :**
- `type: yaml` - SpÃ©cifie explicitement le format
- `ignore_errors: true` - Ignore les erreurs de chargement en dÃ©veloppement

### Toute dÃ©finition de service doit avoir une classe existante

```yaml
# âŒ ERREUR - La classe n'existe pas (ou mauvais namespace)
MonModule\Application\Form\ConfigurationType:
    parent: 'form.type.translatable.aware'
# Error: "has a parent but no class"

# âœ… SOLUTION - VÃ©rifier que le fichier existe avec le bon namespace
# Fichier: src/Application/Form/ConfigurationType.php
# Namespace: MonModule\Application\Form
```

### Emplacement des Adapters

Les Adapters personnalisÃ©s doivent Ãªtre dans `Infrastructure/Adapter/`, pas dans `Wedev/Core/Adapter/`:

```yaml
# âŒ ERREUR - Le Wedev/Core est rÃ©servÃ© au framework
MonModule\Wedev\Core\Adapter\ConfigurationAdapter:
    # ...

# âœ… SOLUTION - Placer dans Infrastructure
MonModule\Infrastructure\Adapter\ConfigurationAdapter:
    # ...
```

**Structure correcte:**
```
src/
â”œâ”€â”€ Wedev/Core/Adapter/          # âŒ NE PAS MODIFIER - Framework WEDEV
â””â”€â”€ Infrastructure/Adapter/      # âœ… VOS adapters personnalisÃ©s
    â””â”€â”€ ConfigurationAdapter.php
```

---

## ğŸ–¥ï¸ Vue.js / TypeScript

### CohÃ©rence du nom de la variable globale

Choisir UN nom pour la configuration globale et l'utiliser partout:

```typescript
// âŒ INCOHÃ‰RENT - MÃ©lange de noms
window.acfpsConfig.apiUrl    // Dans un fichier
window.acfConfig.apiUrl      // Dans un autre fichier

// âœ… COHÃ‰RENT - Un seul nom partout
// DÃ©finir dans le template Twig:
window.moduleConfig = { ... };

// Utiliser partout dans Vue:
const config = window.moduleConfig;
```

**Checklist aprÃ¨s renommage d'un module:**
- [ ] `window.xxxConfig` dans le template Twig
- [ ] `window.xxxConfig` dans les stores Pinia/Vuex
- [ ] `window.xxxConfig` dans les composables
- [ ] `window.xxxConfig` dans les types TypeScript

### Scoped Vue styles vs Global SCSS

```
âŒ ERREUR - Styles dupliquÃ©s dans les composants Vue scoped
   <style scoped>
   .ps-switch { ... }  â† Override les styles globaux!
   </style>

âœ… CORRECT - Utiliser les classes globales de _dev/scss/
   <style scoped>
   /* Styles spÃ©cifiques au composant uniquement */
   .my-component-specific { ... }
   </style>
```

**RÃ¨gle:** Ne JAMAIS redÃ©finir dans `<style scoped>` des classes qui existent dans `_dev/scss/` (`.ps-switch`, `.form-group`, `.btn`, etc.)

### Rebuild aprÃ¨s modification

```bash
# âš ï¸ DEUX BUILDS sÃ©parÃ©s si module avec Vue.js admin!

# MÃ©thode 1: Commandes combinÃ©es (depuis la racine du module)
npm run build:all       # Build Encore + Vue.js
npm run watch:all       # Watch les deux en parallÃ¨le

# MÃ©thode 2: SÃ©parÃ©ment
npm run build           # Encore uniquement (_dev/ â†’ views/dist/)
npm run vue:build       # Vue.js uniquement (views/js/admin/)

# Installer les dÃ©pendances des deux systÃ¨mes
npm install             # Installe root + Vue.js (via postinstall)
```

### Assets dans les mauvais dossiers

```
âŒ ERREUR - Mauvais chemins dans le template Twig:
   /modules/xxx/views/css/admin.css     â† N'existe pas!
   /modules/xxx/views/js/admin.js       â† N'existe pas!

âœ… CORRECT - Chemins vers les builds:
   /modules/xxx/views/dist/admin.css    â† Encore build
   /modules/xxx/views/dist/admin.js     â† Encore build
   /modules/xxx/views/js/admin/dist/acf-main.css  â† Vue.js build
   /modules/xxx/views/js/admin/dist/acf-admin.js  â† Vue.js build
```

---

## ğŸ—„ï¸ Base de DonnÃ©es

### NULL et Foreign Keys

InsÃ©rer `NULL` explicitement dans une colonne avec `DEFAULT NULL` peut causer des erreurs avec les contraintes de clÃ© Ã©trangÃ¨re.

```php
// âŒ ERREUR - Insertion explicite de NULL
$data = [
    'id_parent' => null,  // Peut Ã©chouer avec FK constraint
    // ...
];
Db::getInstance()->insert($table, $data);

// âœ… SOLUTION - Omettre la colonne pour DEFAULT NULL
$data = [
    // 'id_parent' => null,  // NE PAS inclure
    // ...
];
// La colonne prendra sa valeur DEFAULT NULL automatiquement
```

### NULL dans les contraintes UNIQUE

MySQL ne considÃ¨re PAS `NULL = NULL` dans les contraintes UNIQUE. Plusieurs lignes avec `NULL` peuvent exister.

```php
// Contrainte: UNIQUE(id_field, id_product, id_shop, id_lang)
// Avec id_lang = NULL (champ non traduisible)

// âŒ PROBLÃˆME - Plusieurs valeurs NULL autorisÃ©es
INSERT (field_1, product_1, shop_1, NULL)  // OK
INSERT (field_1, product_1, shop_1, NULL)  // OK aussi! (pas de violation)

// âœ… SOLUTION - DELETE avant INSERT pour les champs NULL
if ($langId === null) {
    // Supprimer l'ancienne valeur avant d'insÃ©rer
    Db::getInstance()->delete($table, $where);
}
Db::getInstance()->insert($table, $data);
```

### json_decode() et valeurs NULL

```php
// âŒ ERREUR - json_decode() sur NULL
$value = $row['json_column'];  // Peut Ãªtre NULL
$decoded = json_decode($value, true);  // TypeError si NULL

// âœ… SOLUTION - VÃ©rifier avant de dÃ©coder
$value = $row['json_column'];
$decoded = $value !== null ? json_decode($value, true) : [];
```

---

## ğŸª PrestaShop Context (CRITIQUE)

### Service locator limitÃ© en PrestaShop 8

**PrestaShop 8** utilise un service locator limitÃ© dans `FrameworkBundleAdminController` qui ne contient que certains services de base. **NE JAMAIS** accÃ©der Ã  `Context::getContext()` directement dans les contrÃ´leurs Symfony.

```php
// âŒ ERREUR - Fonctionne en PS9 mais PAS en PS8
class DashboardController extends FrameworkBundleAdminController
{
    public function index(Request $request): Response
    {
        $idShop = Context::getContext()->shop->id;  // ERREUR EN PS8!
        $link = Context::getContext()->link;         // ERREUR EN PS8!
        // ...
    }
}

// âœ… SOLUTION - Utiliser ContextAdapter du framework WEDEV
class DashboardController extends FrameworkBundleAdminController
{
    public function __construct(
        private readonly ContextAdapter $contextAdapter
    ) {}

    public function index(Request $request): Response
    {
        $idShop = $this->contextAdapter->getShopId();     // âœ… Compatible PS8+PS9
        $link = $this->contextAdapter->getLink();          // âœ… Compatible PS8+PS9
        // ...
    }
}
```

**Pourquoi Ã§a arrive ?**
- PS8: `FrameworkBundleAdminController` utilise un service locator limitÃ©
- PS9: Service locator plus permissif
- Solution: Injection de dÃ©pendances avec `ContextAdapter`

**Configuration services.yml:**
```yaml
# DÃ©clarer le ContextAdapter
MonModule\Wedev\Core\Adapter\ContextAdapter:
    public: true

# Injecter dans les contrÃ´leurs
MonModule\Presentation\Controller\Admin\DashboardController:
    arguments:
        $contextAdapter: '@MonModule\Wedev\Core\Adapter\ContextAdapter'
    tags: ['controller.service_arguments']

# Injecter dans les services
MonModule\Application\Service\MyService:
    arguments:
        $contextAdapter: '@MonModule\Wedev\Core\Adapter\ContextAdapter'
```

**MÃ©thodes ContextAdapter disponibles:**
```php
$this->contextAdapter->getShopId();        // ID boutique
$this->contextAdapter->getShop();          // Objet Shop
$this->contextAdapter->getLanguageId();    // ID langue
$this->contextAdapter->getLanguage();      // Objet Language
$this->contextAdapter->getLink();          // Objet Link
$this->contextAdapter->getContext();       // Objet Context complet
```

**RÃ¨gle absolue:**
- âœ… Controllers Symfony â†’ `ContextAdapter` injectÃ©
- âœ… Services applicatifs â†’ `ContextAdapter` injectÃ©
- âœ… Controllers legacy â†’ `Context::getContext()` autorisÃ©
- âŒ Jamais `Context::getContext()` dans controllers Symfony

**Checklist:**
- [ ] Tous les contrÃ´leurs Symfony injectent `ContextAdapter`
- [ ] Services.yml dÃ©clare le `ContextAdapter`
- [ ] Plus d'accÃ¨s direct Ã  `Context::getContext()` dans les contrÃ´leurs Symfony


## ğŸ§® Division par zÃ©ro (CRITIQUE)

### Cast des valeurs avant division

Les valeurs rÃ©cupÃ©rÃ©es de la base de donnÃ©es peuvent Ãªtre `null`, des chaÃ®nes vides, ou des valeurs inattendues. **Toujours caster explicitement** avant les divisions.

```php
// âŒ ERREUR - Division par zÃ©ro possible
$result = $db->getRow($sql);
if ($result['total'] === 0) {
    return 100;
}
return (int) round(($result['ok_count'] / $result['total']) * 100);

// âœ… SOLUTION - Cast et vÃ©rifications strictes
$result = $db->getRow($sql);
if (! $result || !isset($result['total']) || (int) $result['total'] === 0) {
    return 100;
}
return (int) round(((int) $result['ok_count'] / (int) $result['total']) * 100);
```

**Pourquoi Ã§a arrive ?**
- `$result['total']` peut Ãªtre `null`, `'0'`, ou chaÃ®ne vide
- `=== 0` ne capture pas tous les cas de "valeur nulle"
- Les valeurs de DB sont souvent des chaÃ®nes, pas des entiers

**Checklist:**
- [ ] Toujours caster avec `(int)` avant division
- [ ] VÃ©rifier `isset()` avant accÃ¨s aux clÃ©s
- [ ] Tester avec base vide (pas de donnÃ©es)

---

## ğŸ“‹ Checklist DÃ©veloppement

### Avant de coder
- [ ] Lire les rÃ¨gles `.cursor/rules/` du module
- [ ] VÃ©rifier la structure des fichiers existants
- [ ] Identifier les namespaces utilisÃ©s

### Pendant le dÃ©veloppement
- [ ] Styles en SCSS dans `_dev/scss/`, pas en CSS
- [ ] Pas de mÃ©thode `get()` dans les contrÃ´leurs API
- [ ] Services dans `services.yml` â†’ classes existantes
- [ ] Adapters dans `Infrastructure/Adapter/`, pas dans `Wedev/Core/`
- [ ] Variable globale JS cohÃ©rente partout

### Avant de tester
- [ ] `npm run build` pour les assets SCSS/JS
- [ ] `cd views/js/admin && npm run build` pour Vue.js
- [ ] Vider le cache PrestaShop (`rm -rf var/cache/*`)

### Avant de commit
- [ ] `composer cs-check` passe
- [ ] `composer phpstan` passe
- [ ] Pas de fichiers `.css` dans `views/css/` (sauf compilÃ©s)
- [ ] Pas de `window.oldModuleName` restants dans le code JS

---

## ğŸ” Messages d'erreur courants

| Erreur | Cause | Solution |
|-----|----|----|
| `Declaration must be compatible with FrameworkBundleAdminController::get()` | MÃ©thode `get()` en conflit | Renommer en `show()` |
| `has a parent but no class` | Service sans classe existante | CrÃ©er la classe ou supprimer le service |
| `class does not exist` | Mauvais namespace dans services.yml | VÃ©rifier le chemin du fichier PHP |
| 404 sur les assets JS/CSS | Assets non compilÃ©s | ExÃ©cuter `npm run build` |
| Interface Vue vide / cassÃ©e | Variable globale mal nommÃ©e | VÃ©rifier cohÃ©rence `window.xxxConfig` |
| `Syntax Error` sur `?.` (optional chaining) | Babel ne supporte pas ES2020+ par dÃ©faut | Ã‰viter `?.` ou configurer Babel (voir ci-dessous) |
| `Deprecation The legacy JS API is deprecated` (Sass) | sass-loader utilise l'ancienne API | Configurer sass-loader avec `api: 'modern'` |
| `Install file-loader to use copyFiles()` | DÃ©pendance manquante | `npm install file-loader@^6.0.0 --save-dev` |

---

## ğŸ› ï¸ Webpack Encore - Erreurs courantes

### Optional Chaining (`?.`) non supportÃ©

Babel avec Encore ne supporte pas `?.` et `??` par dÃ©faut. **Ã‰viter ces syntaxes:**

```javascript
// âŒ ERREUR - Optional chaining non supportÃ©
element.querySelector('.title')?.textContent = item.title;
const items = data?.items?.length || 0;

// âœ… SOLUTION - Syntaxe traditionnelle
const titleEl = element.querySelector('.title');
if (titleEl) {
    titleEl.textContent = item.title;
}
const items = (data && data.items && data.items.length) || 0;
```

**Alternative:** Configurer Babel pour ES2020+:

```javascript
// webpack.config.js
.configureBabel((config) => {
    config.plugins.push('@babel/plugin-proposal-optional-chaining');
    config.plugins.push('@babel/plugin-proposal-nullish-coalescing-operator');
})
```

### Sass Legacy API Deprecation

Warning: `Deprecation The legacy JS API is deprecated and will be removed in Dart Sass 2.0.0`

```javascript
// webpack.config.js - Configurer sass-loader avec l'API moderne
.enableSassLoader((options) => {
    options.sassOptions = {
        api: 'modern',
    };
})
